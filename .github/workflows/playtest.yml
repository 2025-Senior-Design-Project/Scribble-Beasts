name: Playtest CI

# Triggers the workflow on push or pull request events for the main branch
on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  # Set a consistent project name so Docker Compose generates predictable image names
  # Images will be named: scribblebeasts-client, scribblebeasts-server, etc.
  COMPOSE_PROJECT_NAME: scribblebeasts
  # Define the registry and owner for tagging images
  REGISTRY: ghcr.io

jobs:
  # Job to lint the codebase
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run Linter
        run: echo "Linting step is currently disabled."
        #run: npm run lint

  # Job to build the Docker images and run integration tests
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: cp .env.example .env

      # Build and start the services using Docker Compose
      # We build the images here. They will be tagged as scribblebeasts-client, scribblebeasts-server
      - name: Start services (Build & Test)
        env:
          TUNNEL_TOKEN: ${{ secrets.TUNNEL_TOKEN }}
        run: |
          docker compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.playtest.yml up --build --detach

      - name: Wait for services to initialize
        run: sleep 20

      # Verify critical services are up
      - name: Check service status
        run: |
          echo "Checking status of services..."
          docker compose ps
          if [ $(docker compose ps -q client | wc -l) -eq 0 ]; then echo "Client service failed to start"; exit 1; fi
          if [ $(docker compose ps -q server | wc -l) -eq 0 ]; then echo "Server service failed to start"; exit 1; fi
          if [ $(docker compose ps -q nginx | wc -l) -eq 0 ]; then echo "Nginx service failed to start"; exit 1; fi
          echo "All critical services started successfully!"

      - name: Tear down services
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.playtest.yml down

  # Job to push the Docker images to GHCR (only on push to main)
  publish:
    runs-on: ubuntu-latest
    needs: [integration-test, lint]
    # TEMPORARY: Publish on all branches for testing. Uncomment the line below to restrict to main branch later.
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: read
      packages: write # Required to push images to GHCR
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        # Needed for Docker Compose variable substitution during build
        run: cp .env.example .env

      # Re-build images to ensure we have them locally for pushing
      # Docker caching might speed this up if layers match
      - name: Build images
        run: |
          docker compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.playtest.yml build

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Tag and Push Docker images
        run: |
          # Convert owner to lowercase for Docker tags
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO_NAME=$(echo "${{ github.event.repository.name }}" | tr '[:upper:]' '[:lower:]')

          # Define image names
          CLIENT_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-client"
          SERVER_IMAGE="$REGISTRY/$OWNER/$REPO_NAME-server"

          # Get short SHA for version tagging
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          VERSION_TAG="v-${SHORT_SHA}"

          echo "Pushing images with tag: $VERSION_TAG"

          # Tag and Push Client
          docker tag scribblebeasts-client:latest $CLIENT_IMAGE:latest
          docker tag scribblebeasts-client:latest $CLIENT_IMAGE:$VERSION_TAG
          docker push $CLIENT_IMAGE:latest
          docker push $CLIENT_IMAGE:$VERSION_TAG

          # Tag and Push Server
          docker tag scribblebeasts-server:latest $SERVER_IMAGE:latest
          docker tag scribblebeasts-server:latest $SERVER_IMAGE:$VERSION_TAG
          docker push $SERVER_IMAGE:latest
          docker push $SERVER_IMAGE:$VERSION_TAG
