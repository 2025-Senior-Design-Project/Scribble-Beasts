name: Playtest CI

# Triggers the workflow on push or pull request events for the main branch
on:
  push:
    branches: ['main']
  pull_request:
    branches: ['main']

env:
  # Set a consistent project name so Docker Compose generates predictable image names
  # Images will be named: scribblebeasts-client, scribblebeasts-server, etc.
  COMPOSE_PROJECT_NAME: scribblebeasts
  # Define the registry and owner for tagging images
  REGISTRY: ghcr.io
  # Define the repository URL for linking packages
  REPO_URL: https://github.com/${{ github.repository }}

jobs:
  # Job to lint the codebase
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Run Linter
        run: echo "Linting step is currently disabled."
        #run: npm run lint

  # Job to build the Docker images and run integration tests
  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: cp .env.example .env

      # Build and start the services using Docker Compose
      # We build the images here. They will be tagged as scribblebeasts-client, scribblebeasts-server
      - name: Start services (Build & Test)
        env:
          TUNNEL_TOKEN: ${{ secrets.TUNNEL_TOKEN }}
        run: npm run playtest:run

      # Verify critical services are up
      - name: Check service status
        run: |
          echo "Checking status of services..."
          docker compose ps
          echo "All critical services started successfully!"

      - name: Print logs on failure
        if: failure()
        run: docker compose logs

      - name: Tear down services
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.dev.yml -f docker-compose.playtest.yml down

  # Job to deploy to Fly.io (only on push to main)
  deploy:
    runs-on: ubuntu-latest
    needs: [integration-test, lint]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: npm run deploy
